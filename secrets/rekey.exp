#!/usr/bin/env expect

send_user "Enter SSH password: "
stty -echo
expect_user -re "(.*)\n"
stty echo
send_user "\n"
set password $expect_out(1,string)

spawn agenix -r
while {1} {
  expect {
    "Enter passphrase for" {
      send "$password\r"
    } eof {
      send_user "Finished rekeying\n"
      break;
    } timeout {
      send_user "Timeout while rekeying\n"
      break;
    }
  }
}